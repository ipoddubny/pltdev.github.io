<html>
<head>
    <title>Plantronics JavaScript Sample</title>
</head>
<body onload="connectToSpokes()" onbeforeunload="disconnectFromSpokes()">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="https://pltdev.github.io/spokes.js"></script>
    <script src="https://pltdev.github.io/util.js"></script>
    <!-- Main page -->
    <h1>Plantronics JavaScript Sample</h1>
    Pre-requisite, install Plantronics Hub from: <a href="http://www.plantronics.com/software" target="_new">www.plantronics.com/software</a>
    <p>Note Firefox users: If you get "Error connecting to Plantronics Hub." then visit this URL: <a href="https://127.0.0.1:32018/Spokes/DeviceServices/Info" target="_new">https://127.0.0.1:32018/Spokes/DeviceServices/Info</a> and click Advanced > Add Exception... to add a security exception to allow the connection.</p>

    <p>
        <b>plt sample menu<br />
        --</b><br />
        <button id="incoming_call">ring/incoming call</button><br />
        <button id="outgoing_call">outgoing call</button><br />
        <button id="answer_call">answer call</button><br />
        <button id="hold_call">hold call</button><br />
        <button id="resume_call">resume call</button><br />
        <button id="mute_call">mute call</button><br />
        <button id="unmute_call">unmute call</button><br />
        <button id="end_call">end call</button>
    </p>

    <button id="clear_log">Clear Log</button>

    <div id="log"><b>Log:</b></div>
    <script type="text/javascript">
        var spokes; // global Spokes object, initialised when you click connect below
        var plugin_registered = false;
        var plugin_name = "Hello World JavaScript Plugin";
        var callid = 0;
        var deviceAttached = true;
        var pollRate = 2000;
        var previousPollRate = 2000;
        // start polling the device for events...
        var run = setInterval(pollDeviceEventsOrReconnect, pollRate);

        // Sample menu commands:
        $('#clear_log').click(function () {
            log.innerHTML = "<b>Log:</b>";
        });

        $('#incoming_call').click(function () {
            callid = callid + 1;
            call_id = callid;
            appendLog("<font color=\"#00FF00\">Initiating make call command, call id = " + callid.toString() + "</font>");

            spokes.Plugin.incomingCall(plugin_name, getCallId(callid), getContact("Dummy Contact"), "Unknown", "ToHeadset", function (result) {
                showCallStatus(result);
            });
        });

        $('#outgoing_call').click(function () {
            callid = callid + 1;
            call_id = callid;
            appendLog("<font color=\"#00FF00\">Initiating make call command, call id = " + callid.toString() + "</font>");

            spokes.Plugin.outgoingCall(plugin_name, getCallId(callid), getContact("Dummy Contact"), "ToHeadset", function (result) {
                showCallStatus(result);
            });
        });

        $('#answer_call').click(function () {
            appendLog("<font color=\"#00FF00\">Answering call command, call id = " + callid.toString() + "</font>");

            spokes.Plugin.answerCall(plugin_name, getCallId(callid), function (result) {
                showCallStatus(result);
            });
        });

        $('#hold_call').click(function () {
            appendLog("<font color=\"#00FF00\">Answering call command, call id = " + callid.toString() + "</font>");

            spokes.Plugin.holdCall(plugin_name, getCallId(callid), function (result) {
                showCallStatus(result);
            });
        });

        $('#resume_call').click(function () {
            appendLog("<font color=\"#00FF00\">Answering call command, call id = " + callid.toString() + "</font>");

            spokes.Plugin.resumeCall(plugin_name, getCallId(callid), function (result) {
                showCallStatus(result);
            });
        });

        $('#mute_call').click(function () {
            appendLog("<font color=\"#00FF00\">Muting call</font>");

            spokes.Plugin.muteCall(plugin_name, true, function (result) {
                showCallStatus(result);
            });
        });

        $('#unmute_call').click(function () {
            appendLog("<font color=\"#00FF00\">Unmuting call</font>");

            spokes.Plugin.muteCall(plugin_name, false, function (result) {
                showCallStatus(result);
            });
        });

        $('#end_call').click(function () {
            appendLog("<font color=\"#00FF00\">Ending call, call id = " + callid.toString() + "</font>");

            spokes.Plugin.terminateCall(plugin_name, getCallId(callid), function (result) {
                showCallStatus(result);
            });
        });

        // Other helper functions:

        function getCallId(callid) {
            return new SpokesCallId({ Id: '' + callid } );
        }

        function getContact(contactname) {
            return new SpokesContact({ Name: contactname });
        }

        // displays status of call commands
        function showCallStatus(result, toJson) {
            if (result.isError) {
                appendLog("Error: " + result.Err.Description);
            } else {
                if (toJson) appendLog(JSON.stringify(result.Result))
                else appendLog("Success.");
            }
        };

        function appendLog(str) {
            log.innerHTML = log.innerHTML + "<br />" + str;
        }

        function connectToSpokes() {
            // check Jquery is loaded before using Spokes object...
            //checkJquery();

            //Create my spokes object
            spokes = new Spokes("https://127.0.0.1:32018/Spokes");

            // get list of attached devices
            //spokes.Device.deviceList(function (result) {
            spokes.Device.deviceInfo(function (result) {
                //Create table of all the devices we found if no errors
                if (!result.isError) {
                    if (result.Result /*[0]*/ != null) {
                        // Log Spokes active device found (first in list returned, index 0)
                        appendLog("Device found = " + result.Result /*[0]*/.ProductName + ", id = " + result.Result /*[0]*/.Uid);

                        deviceAttached = true;

                        // attach to the device
                        spokes.Device.attach(result.Result /*[0]*/.Uid, controlInterface);
                    } else {
                        appendLog("Error: Device was null on connecting to Spokes. Is there a Plantronics device connected?");
                        deviceAttached = false;
                    }
                    pollRate = 2000; // waiting for device now, force faster polling rate to start now
                    if (previousPollRate == 10000) {
                        var previousPollRate = 2000;
                        // start polling the device for events...
                        var run = setInterval(pollDeviceEventsOrReconnect, pollRate);
                    }
                } else {
                    if (result.Err.Description === "There are no supported devices") {
                        appendLog("Please attach a Plantronics headset to the PC.");
                    }
                    else
                    { 
                        appendLog("Error connecting to Plantronics Hub. (Have you installed and run Plantronics Hub from <a href=\"http://www.plantronics.com/software\" target=\"_new\">www.plantronics.com/software</a>, or " +
                            "are you Firefox user and getting \"Error connecting to Plantronics Hub.\"? If so visit this URL: <a href=\"https://127.0.0.1:32018/Spokes/DeviceServices/Info\" target=\"_new\">" +
                            "https://127.0.0.1:32018/Spokes/DeviceServices/Info</a> and click Advanced > Add Exception... to add a security exception to allow the connection.");
                        pollRate = 10000; // waiting for Hub to be running
                    }
                }
            });
        }

        //Creates a control interface
        function controlInterface(session) {
            if (session.isError || !spokes.Device.isAttached) {
                appendLog("Session Registration Error");
                deviceAttached = false;
                disconnectFromSpokes();
            } else {
                appendLog("Session ID: " + session.Result);

                registerPlugin();
            }
        }

        function setPluginActive()
        {
            //Set plugin active status to true
            spokes.Plugin.isActive(plugin_name, true, function (result) {
                if (!result.isError) {
                    // plugin registered and active. Show UI.
                    plugin_registered = true;
                    appendLog("Plugin \"" + plugin_name + "\" registered successfully.");
                } else {
                    appendLog("Error checking if plugin is active: " + result.Err.Description);
                }
            });
        }

        // Register a Spokes Plugin session to get access to Call Services and Session Manager interfaces
        function registerPlugin() {
            //Choose to register, or unregister the plugin
            if (!plugin_registered) {
                // register new plugin to Spokes
                spokes.Plugin.register(plugin_name, function (result) {
                    if (!result.isError) {
                        setPluginActive();
                    } else {
                        appendLog("Info: registering plugin: " + result.Err.Description);
                        if (result.Err.Description === "Plugin exists")
                        {
                            setPluginActive();
                        }
                        else
                        {
                            deviceAttached = false;
                            disconnectFromSpokes();
                        }
                    }
                });
            }
        }

        // Unregister Spokes plugin session
        function unregisterPlugin() {
            spokes.Plugin.unRegister(plugin_name);
            plugin_registered = false;
            appendLog("Plugin un-registered.");
        }

        function disconnectFromSpokes() {
            unregisterPlugin();
            spokes.Device.release(function (result) {
                if (!result.isError) {
                    appendLog("Released device");
                } else {
                    appendLog("Error releasing device");
                }
                appendLog("Disconnected from Spokes");
            });
        }

        // Set up device event polling if we are connected to Hub, or attempt to reconnect to Hub
        function pollDeviceEventsOrReconnect() {
            if (previousPollRate != pollRate) {
                clearInterval(run);
                previousPollRate = pollRate;
                run = setInterval(pollDeviceEventsOrReconnect, pollRate); // variable poll rate, 2000ms waiting for device, 10000ms waiting for Hub to be running
            }
            if (spokes == null || !deviceAttached || !spokes.Device.isAttached) {
                appendLog("-- POLLING FOR HUB / DEVICE RE-ATTACH --");
                connectToSpokes();
                return;
            }

            //Make an events call
            spokes.Device.events(
                function (result) {
                    if (result.isError) {
                        appendLog("Error polling for device events: " + result.Err.Description);
                        if (result.Err.Description === "No response.  Server appears to be offline.") {
                            pollRate = 10000;
                            appendLog("changing POLL RATE to " + pollRate);
                        }
                        if (result.Err.Description === "Invalid session id" ||
                            result.Err.Description === "Empty session id" ||
                            result.Err.Description === "No response.  Server appears to be offline.") {
                            appendLog("-- ** DEVICE DETACHED / SESSION INVALID ** --");
                            deviceAttached = false;
                            disconnectFromSpokes();
                        }
                    } else {
                        // display list of events collected from REST service
                        if (result.Result.length > 0) {
                            for (var i = 0; i < result.Result.length; i++) {
                                appendLog("<font color=\"#0000FF\">Device Event: " + result.Result[i].Event_Log_Type_Name + ", " + print_r(result.Result[i]) + "</font>");
                            }
                        }
                    }
                });

            spokes.Plugin.callEvents(plugin_name,
                function (result) {
                    if (result.isError) {
                        appendLog("Error polling for call events: " + result.Err.Description);
                        if (result.Err.Description === "No response.  Server appears to be offline.") {
                            pollRate = 10000;
                            appendLog("changing POLL RATE to " + pollRate);
                        }
                        if (result.Err.Description === "Invalid session id" ||
                            result.Err.Description === "Empty session id" ||
                            result.Err.Description === "No response.  Server appears to be offline.") {
                            appendLog("-- ** DEVICE DETACHED / SESSION INVALID ** --");
                            deviceAttached = false;
                            disconnectFromSpokes();
                        }
                    } else {
                        // display list of events collected from REST service
                        if (result.Result.length > 0) {
                            for (var i = 0; i < result.Result.length; i++) {
                                appendLog("<font color=\"#0000FF\">Call Event: " + result.Result[i].Event_Log_Type_Name + ", " + print_r(result.Result[i]) + "</font>");
                                // Now workout the actual call state and call id in question:
                                var callState = SessionCallState.Lookup[result.Result[i]["Action"]];
                                var callId = result.Result[i]["CallId"]["Id"];
                                appendLog("CallState: " + callState + ", Call ID: " + callId);
                            }
                        }
                    }
                });
        }
    </script>
</body>
</html>